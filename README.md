## **PROJET** 

Cr√©ation d'un cluster EKS via Terraform

### How to setup ?

#### Initiate backend configuration

You need to create the backend configuration file (eg. config.s3.tfbackend) then you can run : `terraform init -backend-config="./config.s3.tfbackend"`

```tf
region = "<REGION>"
bucket= "<BUCKET_NAME>"
key = "<FILENAME>"
use_lockfile = <true / false>
```

## Download pre requisite

You need to download `kubectl` and `eksctl`. 

#### Kubectl

Just run : 
```bash
sudo apt install kubectl
```

#### Eksctl

Run the following:

```bash
ARCH=amd64
PLATFORM=$(uname -s)_$ARCH

curl -sLO "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_$PLATFORM.tar.gz"

# Checksum check
curl -sL "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_checksums.txt" | grep $PLATFORM | sha256sum --check

tar -xzf eksctl_$PLATFORM.tar.gz -C /tmp && rm eksctl_$PLATFORM.tar.gz

sudo install -m 0755 /tmp/eksctl /usr/local/bin && rm /tmp/eksctl

# Enable completion on bash
. <(eksctl completion bash)
```

## How to test EC2 instance ?

### SSH connection

A *key.pem* is generated by Terraform. You can use it to connect :

```bash
ssh -i "key.pem" ec2_user@<IP_PUB>
```

### Web service

We deployed a httpd service that we can access through a web browser by searching: 

```bash
http://<IP_PUB>
```

## Standardization

In a DevOps context, we may need to standardise our deployment workflow. That is why we set up a Makefile to ensure an assured workload.

### How to use Makefile ?

First, you need to initialize the Terraform project:

```bash
make init ARGS="<YOUR_BACKEND_CONFIG_FILE>"
```

To do a `terraform plan` use:

```bash
make plan
```

To do a `terraform apply` use:

```bash
make apply
```

To do a `terraform destroy` use:

```bash
make destroy
```


#### Sources

- https://stackoverflow.com/questions/52040798/terraform-outputs-for-resources-with-count
- https://stackoverflow.com/questions/2214575/passing-arguments-to-make-run
- https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_attachment
- https://spacelift.io/blog/terraform-alb